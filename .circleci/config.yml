# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2
jobs:
  run-lint-test:
    docker:
      - image: python:3.7

    working_directory: ~/project

    steps:
      - checkout

      - run:
          name: install dependencies
          command: |
            python3 -m venv ~/.devops
            source ~/.devops/bin/activate
            make install
            wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.10.0/hadolint-Linux-x86_64 &&\
            chmod +x /bin/hadolint
        
      - run:
          name: run lint
          command: |
            python3 -m venv ~/.devops
            source ~/.devops/bin/activate
            make lint

  build-docker-image:
    docker:
      - image: docker:17.05.0-ce-git
    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: Build application Docker image
          command: |
            docker build -t handuy1992/final-proj .

      - run:
          name: Push application Docker image
          command: |
            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push handuy1992/final-proj

workflows:
  default:
    jobs:
      - run-lint-test
      - build-docker-image:
          requires: [run-lint-test]
      # - test-backend:
      #     requires: [build-backend]
      # - scan-backend:
      #     requires: [build-backend]
      # - scan-frontend:
      #     requires: [build-frontend]
      # - deploy-infrastructure:
      #     requires: [test-frontend, test-backend, scan-frontend, scan-backend]
      #     filters:
      #       branches:
      #         only: [master]